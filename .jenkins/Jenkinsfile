pipeline {
  agent any
  environment {
    scmInfo = checkout scm
    gitBranch = scmInfo.GIT_BRANCH.replace("origin/", "")
    NODEJS_HOME = "${tool 'node-16'}"
    PATH="${NODEJS_HOME}/bin:${env.PATH}"
  }
  stages {
    stage('Setup') {
      steps {
        sh 'rm -rf dist'
        sh 'yarn install --frozen-lockfile --non-interactive'
      }
    }
    stage('Lint') {
      steps {
        sh 'yarn -s lint'
      }
    }
    stage('Build') {
      steps {
        sh './scripts/build.mjs'
      }
    }
    stage('Unit tests') {
      steps {
        sh 'yarn -s test:ci'
      }
    }
    stage('E2E tests') {
      steps {
        sh './scripts/e2e-ci.mjs'
      }
    }
    stage('Build release') {
      steps {
        sh './scripts/release.mjs'
        sh './scripts/jenkins/create-build-artifacts.mjs'
        archiveArtifacts 'dist/artifacts/**/*.tgz'
      }
    }
    stage('Publish snapshots') {
      when {
        expression {
          return gitBranch == 'master'
        }
      }
      steps {
        sh './scripts/build-docs.mjs'
        sh './scripts/jenkins/publish-snapshots.sh'
      }
    }
    stage('Publish') {
      steps {
        sh './scripts/publish.mjs'
      }
    }
  }
}
